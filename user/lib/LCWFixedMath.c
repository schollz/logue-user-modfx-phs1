/*
Copyright 2019 Tomoaki Itoh
This software is released under the MIT License, see LICENSE.txt.
//*/

#include "LCWFixedMath.h"

#define LCW_POW2_TABLE_BITS (8)
#define LCW_POW2_TABLE_SIZE (1 << LCW_POW2_TABLE_BITS)
#define LCW_POW2_TABLE_MASK (LCW_POW2_TABLE_SIZE - 1)
static const UQ4_12 pow2Table[LCW_POW2_TABLE_SIZE + 1] = {
    0x1000, 0x100B, 0x1016, 0x1021, 0x102C, 0x1037, 0x1043, 0x104E,
    0x1059, 0x1065, 0x1070, 0x107B, 0x1087, 0x1092, 0x109E, 0x10A9,
    0x10B5, 0x10C0, 0x10CC, 0x10D8, 0x10E3, 0x10EF, 0x10FB, 0x1107,
    0x1113, 0x111E, 0x112A, 0x1136, 0x1142, 0x114E, 0x115A, 0x1166,
    0x1172, 0x117E, 0x118A, 0x1197, 0x11A3, 0x11AF, 0x11BB, 0x11C8,
    0x11D4, 0x11E0, 0x11ED, 0x11F9, 0x1206, 0x1212, 0x121F, 0x122B,
    0x1238, 0x1245, 0x1251, 0x125E, 0x126B, 0x1278, 0x1284, 0x1291,
    0x129E, 0x12AB, 0x12B8, 0x12C5, 0x12D2, 0x12DF, 0x12EC, 0x12F9,
    0x1306, 0x1314, 0x1321, 0x132E, 0x133C, 0x1349, 0x1356, 0x1364,
    0x1371, 0x137F, 0x138C, 0x139A, 0x13A7, 0x13B5, 0x13C3, 0x13D0,
    0x13DE, 0x13EC, 0x13FA, 0x1408, 0x1416, 0x1423, 0x1431, 0x143F,
    0x144E, 0x145C, 0x146A, 0x1478, 0x1486, 0x1494, 0x14A3, 0x14B1,
    0x14BF, 0x14CE, 0x14DC, 0x14EB, 0x14F9, 0x1508, 0x1516, 0x1525,
    0x1534, 0x1542, 0x1551, 0x1560, 0x156F, 0x157E, 0x158D, 0x159C,
    0x15AB, 0x15BA, 0x15C9, 0x15D8, 0x15E7, 0x15F6, 0x1605, 0x1615,
    0x1624, 0x1633, 0x1643, 0x1652, 0x1662, 0x1671, 0x1681, 0x1690,
    0x16A0, 0x16B0, 0x16C0, 0x16CF, 0x16DF, 0x16EF, 0x16FF, 0x170F,
    0x171F, 0x172F, 0x173F, 0x174F, 0x175F, 0x1770, 0x1780, 0x1790,
    0x17A1, 0x17B1, 0x17C1, 0x17D2, 0x17E2, 0x17F3, 0x1804, 0x1814,
    0x1825, 0x1836, 0x1847, 0x1857, 0x1868, 0x1879, 0x188A, 0x189B,
    0x18AC, 0x18BE, 0x18CF, 0x18E0, 0x18F1, 0x1902, 0x1914, 0x1925,
    0x1937, 0x1948, 0x195A, 0x196B, 0x197D, 0x198F, 0x19A0, 0x19B2,
    0x19C4, 0x19D6, 0x19E8, 0x19FA, 0x1A0C, 0x1A1E, 0x1A30, 0x1A42,
    0x1A55, 0x1A67, 0x1A79, 0x1A8B, 0x1A9E, 0x1AB0, 0x1AC3, 0x1AD5,
    0x1AE8, 0x1AFB, 0x1B0E, 0x1B20, 0x1B33, 0x1B46, 0x1B59, 0x1B6C,
    0x1B7F, 0x1B92, 0x1BA5, 0x1BB8, 0x1BCC, 0x1BDF, 0x1BF2, 0x1C06,
    0x1C19, 0x1C2D, 0x1C40, 0x1C54, 0x1C67, 0x1C7B, 0x1C8F, 0x1CA3,
    0x1CB7, 0x1CCB, 0x1CDF, 0x1CF3, 0x1D07, 0x1D1B, 0x1D2F, 0x1D43,
    0x1D58, 0x1D6C, 0x1D80, 0x1D95, 0x1DA9, 0x1DBE, 0x1DD3, 0x1DE7,
    0x1DFC, 0x1E11, 0x1E26, 0x1E3B, 0x1E50, 0x1E65, 0x1E7A, 0x1E8F,
    0x1EA4, 0x1EB9, 0x1ECF, 0x1EE4, 0x1EFA, 0x1F0F, 0x1F25, 0x1F3A,
    0x1F50, 0x1F66, 0x1F7B, 0x1F91, 0x1FA7, 0x1FBD, 0x1FD3, 0x1FE9,
    0x2000
};

SQ15_16 q16_pow2(SQ15_16 x)
{
    const int32_t lshift = x >> 16;
    const uint32_t frac = (uint32_t)(x & 0xFFFF);
    uint32_t i = frac >> (16 - LCW_POW2_TABLE_BITS);
    uint32_t tmp = frac & (0xFFFF >> LCW_POW2_TABLE_BITS);

    // q12 -> q16
    SQ15_16 val = (SQ15_16)pow2Table[i] << (16 - 12);
    SQ15_16 diff = ((SQ15_16)pow2Table[i+1] << (16 - 12)) - val;
    val += ( (tmp * diff) >> (16 - LCW_POW2_TABLE_BITS) );

    if ( lshift < 0 ) {
        return val >> -lshift;
    }
    else {
        return val << lshift;
    }
}
